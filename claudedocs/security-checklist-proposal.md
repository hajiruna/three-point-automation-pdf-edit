# 社内Webアプリ開発向け セキュリティチェックリスト整備 提案書

**作成日**: 2024年12月
**作成者**: 業務効率化推進チーム
**対象**: 情報システム課

---

## 目次

1. [背景・目的](#1-背景目的)
2. [セキュリティチェックリスト](#2-セキュリティチェックリスト)
   - 2.1 初心者向けチェックリスト
   - 2.2 中級者向けチェックリスト
   - 2.3 共通必須チェック項目
3. [運用ガイド](#3-運用ガイド)
4. [教育計画](#4-教育計画)
5. [導入ロードマップ](#5-導入ロードマップ)
6. [参考資料](#6-参考資料)

---

## 1. 背景・目的

### 1.1 現状認識

社内でのDX推進に伴い、各部門でWebアプリケーションを開発・運用する機会が増加しています。

- **ノーコード/ローコード開発**: Power Apps、Kintone等を活用した業務アプリ
- **コード開発**: Next.js、React等のフレームワークを使用した本格的なWebアプリ

これらのアプリケーションは業務効率化に大きく貢献する一方、適切なセキュリティ対策がなされていない場合、以下のリスクが発生します。

### 1.2 セキュリティリスク

| リスク | 影響 | 発生可能性 |
|--------|------|------------|
| 情報漏洩 | 顧客データ・社内機密情報の流出 | 高 |
| 不正アクセス | システムの改ざん、なりすまし | 中〜高 |
| サービス停止 | 業務継続への影響 | 中 |
| コンプライアンス違反 | 法的責任、信用失墜 | 中 |

### 1.3 実体験からの教訓

今回開発した「PDF Page Selector」プロジェクトにおいて、セキュリティ監査を実施した結果、以下の改善点が発見されました。

| 重大度 | 発見数 | 主な内容 |
|--------|--------|----------|
| 重大（CRITICAL） | 3件 | 認証バイパス、レート制限なし |
| 高（HIGH） | 4件 | 管理者情報露出、CSPヘッダー未設定 |
| 中（MEDIUM） | 4件 | ファイル検証不足、ログ不備 |
| 低（LOW） | 2件 | エラーメッセージの詳細表示 |

これらは開発段階でチェックリストがあれば防げた問題です。

### 1.4 提案概要

本提案では、以下を整備することで、社内Webアプリ開発のセキュリティレベルを向上させます。

1. **レベル別チェックリスト**: 初心者・中級者それぞれに適したチェック項目
2. **2段階チェック体制**: 開発前（設計時）とリリース前の2回確認
3. **教育プログラム**: 開発者向けセキュリティ研修
4. **継続的改善**: 定期的なチェックリスト更新

---

## 2. セキュリティチェックリスト

### 2.1 初心者向けチェックリスト（ノーコード/ローコード開発）

Power Apps、Kintone、SharePoint等を使用する方向けのシンプルなチェックリストです。

#### 開発前チェック（設計時）

| # | チェック項目 | 確認 |
|---|-------------|------|
| 1 | **アクセス権限の設計**: 誰がこのアプリを使えるか明確に決めましたか？ | [ ] |
| 2 | **データの分類**: 扱うデータに個人情報や機密情報が含まれますか？含まれる場合、情報システム課に相談しましたか？ | [ ] |
| 3 | **認証方式の確認**: 社内アカウント（Azure AD等）でのログインを使いますか？ | [ ] |
| 4 | **外部連携の確認**: 社外のサービス（外部API等）と連携しますか？連携する場合、情報システム課に相談しましたか？ | [ ] |
| 5 | **データ保存場所**: データはどこに保存されますか？（社内サーバー、クラウド等）承認済みの保存先ですか？ | [ ] |

#### リリース前チェック（公開前）

| # | チェック項目 | 確認 |
|---|-------------|------|
| 6 | **テストユーザーでの確認**: 本来アクセスできない人がアクセスできないことを確認しましたか？ | [ ] |
| 7 | **パスワード・秘密情報の確認**: 画面上にパスワードやAPIキーが表示されていませんか？ | [ ] |
| 8 | **エラー表示の確認**: エラー時に内部情報（ファイルパス、データベース名等）が表示されませんか？ | [ ] |
| 9 | **不要な機能の削除**: テスト用の機能やデータが残っていませんか？ | [ ] |
| 10 | **情報システム課の承認**: リリース前に情報システム課の確認を受けましたか？ | [ ] |

---

### 2.2 中級者向けチェックリスト（コード開発）

Next.js、React、Vue.js等のフレームワークで開発する方向けの詳細チェックリストです。
**OWASP Top 10 2021**（Webアプリケーションセキュリティの国際基準）に基づいています。

#### A. 認証・認可（Authentication & Authorization）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| A1 | 認証処理はサーバーサイドで実装している | 必須 | [ ] |
| A2 | パスワードは安全なハッシュ関数（bcrypt, Argon2等）で保存している | 必須 | [ ] |
| A3 | セッションタイムアウトを適切に設定している（推奨: 8時間以内） | 必須 | [ ] |
| A4 | ログイン失敗時のレート制限を実装している | 必須 | [ ] |
| A5 | 管理者権限のチェックはサーバーサイドで行っている | 必須 | [ ] |
| A6 | JWTを使用する場合、有効期限と署名検証を実装している | 推奨 | [ ] |
| A7 | 多要素認証（MFA）を検討している | 推奨 | [ ] |

**実装例（今回のプロジェクトより）**:
```typescript
// セッション設定例（NextAuth.js）
session: {
  strategy: 'jwt',
  maxAge: 8 * 60 * 60,      // 8時間
  updateAge: 60 * 60,        // 1時間ごとに更新
}
```

#### B. 入力検証（Input Validation）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| B1 | すべてのユーザー入力をサーバーサイドで検証している | 必須 | [ ] |
| B2 | スキーマバリデーション（Zod等）を使用している | 推奨 | [ ] |
| B3 | SQLクエリはパラメータ化/プリペアドステートメントを使用している | 必須 | [ ] |
| B4 | ファイルアップロード時、拡張子だけでなくマジックナンバーも検証している | 推奨 | [ ] |
| B5 | ファイルサイズの上限を設定している | 必須 | [ ] |
| B6 | リダイレクトURLは許可リスト（ホワイトリスト）で検証している | 必須 | [ ] |

**実装例（今回のプロジェクトより）**:
```typescript
// Zodによる入力検証例
const schema = z.object({
  priceId: z.string().regex(/^price_/, 'Invalid price ID'),
  successUrl: z.string().url().refine(isAllowedHost),
})

// PDFマジックナンバー検証例
const PDF_MAGIC = [0x25, 0x50, 0x44, 0x46] // %PDF
const header = await readFileHeader(file, 4)
const isValid = PDF_MAGIC.every((b, i) => header[i] === b)
```

#### C. 通信セキュリティ（Transport Security）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| C1 | すべての通信がHTTPS（TLS 1.2以上）で暗号化されている | 必須 | [ ] |
| C2 | HSTSヘッダーを設定している | 必須 | [ ] |
| C3 | 外部APIへの接続時、証明書検証を無効化していない | 必須 | [ ] |

#### D. セキュリティヘッダー（Security Headers）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| D1 | Content-Security-Policy（CSP）を設定している | 必須 | [ ] |
| D2 | X-Frame-Options: SAMEORIGIN を設定している | 必須 | [ ] |
| D3 | X-Content-Type-Options: nosniff を設定している | 必須 | [ ] |
| D4 | Referrer-Policy を設定している | 推奨 | [ ] |
| D5 | Permissions-Policy で不要な機能を制限している | 推奨 | [ ] |

**実装例（今回のプロジェクトより）**:
```javascript
// next.config.mjs
headers: [
  { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
  { key: 'X-Content-Type-Options', value: 'nosniff' },
  { key: 'Strict-Transport-Security', value: 'max-age=63072000; includeSubDomains' },
  { key: 'Content-Security-Policy', value: "default-src 'self'; ..." },
]
```

#### E. エラー処理・ログ（Error Handling & Logging）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| E1 | 本番環境でスタックトレースがユーザーに表示されない | 必須 | [ ] |
| E2 | エラーメッセージに内部情報（DBスキーマ、ファイルパス等）が含まれない | 必須 | [ ] |
| E3 | 認証失敗、権限エラー等のセキュリティイベントをログに記録している | 推奨 | [ ] |
| E4 | ログに個人情報（PII）が含まれないようマスキングしている | 推奨 | [ ] |

**実装例（今回のプロジェクトより）**:
```typescript
// エラーメッセージサニタイズ
function sanitizeError(error: unknown): string {
  const sensitivePatterns = [/password/i, /secret/i, /token/i]
  // 機密情報を含む場合は汎用メッセージを返す
  return 'エラーが発生しました'
}

// PIIマスキング
maskEmail('user@example.com')  // → u***@e***.com
```

#### F. 依存関係・コンポーネント（Dependencies）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| F1 | npm audit で脆弱性をチェックしている | 必須 | [ ] |
| F2 | 定期的に依存パッケージを更新している | 推奨 | [ ] |
| F3 | 使用していないパッケージを削除している | 推奨 | [ ] |

#### G. API・Webhook セキュリティ

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| G1 | APIエンドポイントにレート制限を実装している | 必須 | [ ] |
| G2 | Webhookは署名検証（HMAC等）を実装している | 必須 | [ ] |
| G3 | Webhookの冪等性（二重処理防止）を実装している | 推奨 | [ ] |
| G4 | CORSは必要最小限のオリジンのみ許可している | 必須 | [ ] |

**実装例（今回のプロジェクトより）**:
```typescript
// レート制限設定
const AUTH_RATE_LIMIT = { maxRequests: 10, windowMs: 60000 }  // 1分10回
const DEFAULT_RATE_LIMIT = { maxRequests: 60, windowMs: 60000 } // 1分60回

// Webhook冪等性チェック
if (!markEventProcessed(event.id)) {
  return { received: true, duplicate: true }
}
```

#### H. 環境・設定（Configuration）

| # | チェック項目 | 重要度 | 確認 |
|---|-------------|--------|------|
| H1 | 秘密情報（APIキー、DB接続情報等）は環境変数で管理している | 必須 | [ ] |
| H2 | .env.local は .gitignore に含まれている | 必須 | [ ] |
| H3 | 本番環境でデバッグモードが無効になっている | 必須 | [ ] |
| H4 | NEXT_PUBLIC_ プレフィックスの環境変数に機密情報が含まれていない | 必須 | [ ] |

---

### 2.3 共通必須チェック項目

初心者・中級者共通で、リリース前に必ず確認すべき項目です。

| # | チェック項目 | 確認 |
|---|-------------|------|
| 1 | 社内アカウント（Azure AD）でのログインを使用している | [ ] |
| 2 | 適切なアクセス権限が設定されている（必要な人だけがアクセス可能） | [ ] |
| 3 | 個人情報・機密情報を扱う場合、情報システム課に相談済み | [ ] |
| 4 | テスト用データ・アカウントが本番環境に残っていない | [ ] |
| 5 | 情報システム課のリリース承認を得ている | [ ] |

---

## 3. 運用ガイド

### 3.1 開発前チェック（設計時）

**タイミング**: プロジェクト開始時、設計フェーズ

**目的**: セキュリティ要件の早期把握と対策計画

**プロセス**:
```
1. 開発者がチェックリストを確認
   ↓
2. 該当項目を洗い出し
   ↓
3. 不明点があれば情報システム課に相談
   ↓
4. セキュリティ要件をドキュメント化
   ↓
5. 開発開始
```

**成果物**:
- セキュリティ要件チェックシート（開発前版）

### 3.2 リリース前チェック（最終確認）

**タイミング**: 本番デプロイの前

**目的**: セキュリティ対策の実装確認

**プロセス**:
```
1. 開発者がチェックリストを記入
   ↓
2. セルフチェック完了後、チームリーダーがレビュー
   ↓
3. 情報システム課に提出
   ↓
4. 情報システム課が確認・承認
   ↓
5. 本番デプロイ
```

**成果物**:
- セキュリティチェックシート（リリース前版）
- 承認記録

### 3.3 承認フロー案

```
┌─────────────────┐
│   開発者        │
│ チェックリスト記入│
└────────┬────────┘
         ↓
┌─────────────────┐
│ チームリーダー   │
│ 一次確認・承認   │
└────────┬────────┘
         ↓
┌─────────────────┐
│ 情報システム課   │
│ 最終確認・承認   │
└────────┬────────┘
         ↓
┌─────────────────┐
│   本番デプロイ   │
└─────────────────┘
```

### 3.4 チェックリストの更新サイクル

| 頻度 | 内容 |
|------|------|
| 随時 | セキュリティインシデント発生時の項目追加 |
| 四半期 | 新しい脅威・技術トレンドの反映 |
| 年次 | OWASP等の国際基準との整合性確認 |

---

## 4. 教育計画

### 4.1 初心者向けセキュリティ基礎研修

**対象**: ノーコード/ローコード開発者

**形式**: オンライン研修（1時間）

**内容**:
1. なぜセキュリティが重要か（事例紹介）
2. よくあるセキュリティ問題と対策
3. チェックリストの使い方
4. 困ったときの相談先

**頻度**: 新規開発者向けに随時開催

### 4.2 中級者向け実践ワークショップ

**対象**: コード開発者

**形式**: ハンズオン形式（半日）

**内容**:
1. OWASP Top 10の解説
2. 実際のコードでの脆弱性検出演習
3. セキュアコーディング実践
4. 今回のプロジェクト（PDF Page Selector）での実例紹介

**頻度**: 四半期に1回

### 4.3 定期的な啓発活動

| 活動 | 頻度 | 内容 |
|------|------|------|
| セキュリティニュースレター | 月1回 | 最新の脅威情報、対策のポイント |
| 事例共有会 | 四半期 | 社内外のセキュリティインシデント事例 |
| セキュリティ月間 | 年1回 | 集中的な啓発活動 |

---

## 5. 導入ロードマップ

### Phase 1: チェックリスト導入（1-2ヶ月目）

| 週 | 活動 |
|----|------|
| 1-2週 | チェックリストの社内レビュー・フィードバック収集 |
| 3-4週 | フィードバックを反映した最終版作成 |
| 5-6週 | 全社周知、運用開始 |
| 7-8週 | 初期運用のフォローアップ |

**成果物**:
- 確定版チェックリスト
- 運用マニュアル

### Phase 2: 運用定着・改善（3-6ヶ月目）

| 月 | 活動 |
|----|------|
| 3ヶ月目 | 初回レビュー、改善点の洗い出し |
| 4ヶ月目 | 教育プログラム開始 |
| 5ヶ月目 | チェックリスト改訂（v1.1） |
| 6ヶ月目 | 運用状況の評価 |

**KPI**:
- チェックリスト提出率: 100%
- リリース前チェックでの問題発見数
- セキュリティインシデント発生数

### Phase 3: 継続的改善体制の確立（7ヶ月目以降）

- 四半期ごとのチェックリスト更新
- 年次セキュリティ監査の実施
- 自動化ツールの導入検討（将来）

---

## 6. 参考資料

### 6.1 国際セキュリティ基準

| 基準 | 説明 | URL |
|------|------|-----|
| OWASP Top 10 2021 | Webアプリの10大脆弱性 | https://owasp.org/Top10/ja/ |
| CWE Top 25 | 危険なソフトウェア弱点 | https://cwe.mitre.org/top25/ |

### 6.2 OWASP Top 10 2021 概要

| 順位 | カテゴリ | 説明 |
|------|----------|------|
| A01 | アクセス制御の不備 | 権限チェックの欠如、水平・垂直権限昇格 |
| A02 | 暗号化の失敗 | 機密データの平文保存・送信 |
| A03 | インジェクション | SQL、OS、LDAPインジェクション |
| A04 | 安全でない設計 | 設計段階でのセキュリティ考慮不足 |
| A05 | セキュリティ設定ミス | デフォルト設定、不要な機能の有効化 |
| A06 | 脆弱なコンポーネント | 既知の脆弱性を持つライブラリの使用 |
| A07 | 認証の失敗 | 弱いパスワード、セッション管理不備 |
| A08 | 整合性の失敗 | 安全でないデシリアライゼーション |
| A09 | ログ・監視の失敗 | セキュリティログの欠如 |
| A10 | SSRF | サーバーサイドリクエストフォージェリ |

### 6.3 推奨ツール

| カテゴリ | ツール | 用途 |
|----------|--------|------|
| 依存関係チェック | npm audit | Node.jsパッケージの脆弱性検出 |
| 静的解析 | ESLint + security plugins | コードのセキュリティ問題検出 |
| 動的スキャン | OWASP ZAP | Webアプリの脆弱性スキャン |
| ヘッダー確認 | Mozilla Observatory | HTTPセキュリティヘッダーチェック |

### 6.4 今回のプロジェクトで実施したセキュリティ対策

| カテゴリ | 実施内容 | 該当ファイル |
|----------|----------|--------------|
| 認証 | Azure AD SSO、JWT 8時間有効期限 | route.ts (NextAuth) |
| 認可 | サーバーサイド権限チェック | admin.ts |
| 入力検証 | Zodスキーマバリデーション | validations/billing.ts |
| レート制限 | 多段階制限（認証10回/分、一般60回/分） | security/rate-limit.ts |
| セキュリティヘッダー | CSP、HSTS、X-Frame-Options等 | next.config.mjs |
| ファイル検証 | PDFマジックナンバー検証、サイズ制限 | utils.ts |
| Webhook | HMAC署名検証、冪等性チェック | webhooks/stripe/route.ts |
| エラー処理 | メッセージサニタイズ、PIIマスキング | security/sanitize.ts |

---

## 付録: チェックシートテンプレート

### 開発前チェックシート

```
プロジェクト名: ________________
開発者名: ________________
日付: ____年____月____日

□ アクセス権限の設計を完了した
□ 扱うデータの分類を行った（個人情報含む場合は情報システム課に相談済み）
□ 認証方式を決定した
□ 外部連携の有無を確認した
□ データ保存場所を決定した

署名: ________________
```

### リリース前チェックシート

```
プロジェクト名: ________________
開発者名: ________________
日付: ____年____月____日
本番URL: ________________

【共通チェック】
□ 社内アカウントでのログインを使用している
□ 適切なアクセス権限が設定されている
□ 個人情報・機密情報を扱う場合、情報システム課に相談済み
□ テスト用データ・アカウントが本番環境に残っていない

【技術チェック】（該当する場合のみ）
□ セキュリティヘッダーが設定されている
□ 入力検証が実装されている
□ レート制限が実装されている
□ npm audit でエラーがない

開発者署名: ________________
チームリーダー承認: ________________
情報システム課承認: ________________
```

---

**本提案書に関するお問い合わせ**

ご不明な点がございましたら、業務効率化推進チームまたは情報システム課までお問い合わせください。
